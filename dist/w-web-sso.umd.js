/*!
 * w-web-sso v1.0.6
 * (c) 2018-2021 yuda-lyu(semisphere)
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("path"),require("fs"),require("@hapi/hapi"),require("@hapi/inert"),require("events"),require("stream")):"function"==typeof define&&define.amd?define(["path","fs","@hapi/hapi","@hapi/inert","events","stream"],t):(e="undefined"!=typeof globalThis?globalThis:e||self)["w-web-sso"]=t(e.path,e.fs,e["@hapi/hapi"],e["@hapi/inert"],e.events,e.stream)}(this,(function(e,t,r,n,o,i){"use strict";var a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function u(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var c={exports:{}};!function(e,t){e.exports=function(){var e=1e3,t=6e4,r=36e5,n="millisecond",o="second",i="minute",a="hour",u="day",c="week",s="month",l="quarter",f="year",d="date",h="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,v=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,y={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],r=e%100;return"["+e+(t[(r-20)%10]||t[r]||t[0])+"]"}},g=function(e,t,r){var n=String(e);return!n||n.length>=t?e:""+Array(t+1-n.length).join(r)+e},b={s:g,z:function(e){var t=-e.utcOffset(),r=Math.abs(t),n=Math.floor(r/60),o=r%60;return(t<=0?"+":"-")+g(n,2,"0")+":"+g(o,2,"0")},m:function e(t,r){if(t.date()<r.date())return-e(r,t);var n=12*(r.year()-t.year())+(r.month()-t.month()),o=t.clone().add(n,s),i=r-o<0,a=t.clone().add(n+(i?-1:1),s);return+(-(n+(r-o)/(i?o-a:a-o))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:s,y:f,w:c,d:u,D:d,h:a,m:i,s:o,ms:n,Q:l}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},m="en",w={};w[m]=y;var j="$isDayjsObject",_=function(e){return e instanceof A||!(!e||!e[j])},O=function e(t,r,n){var o;if(!t)return m;if("string"==typeof t){var i=t.toLowerCase();w[i]&&(o=i),r&&(w[i]=r,o=i);var a=t.split("-");if(!o&&a.length>1)return e(a[0])}else{var u=t.name;w[u]=t,o=u}return!n&&o&&(m=o),o||!n&&m},S=function(e,t){if(_(e))return e.clone();var r="object"==typeof t?t:{};return r.date=e,r.args=arguments,new A(r)},k=b;k.l=O,k.i=_,k.w=function(e,t){return S(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var A=function(){function y(e){this.$L=O(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[j]=!0}var g=y.prototype;return g.parse=function(e){this.$d=function(e){var t=e.date,r=e.utc;if(null===t)return new Date(NaN);if(k.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var n=t.match(p);if(n){var o=n[2]-1||0,i=(n[7]||"0").substring(0,3);return r?new Date(Date.UTC(n[1],o,n[3]||1,n[4]||0,n[5]||0,n[6]||0,i)):new Date(n[1],o,n[3]||1,n[4]||0,n[5]||0,n[6]||0,i)}}return new Date(t)}(e),this.init()},g.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},g.$utils=function(){return k},g.isValid=function(){return!(this.$d.toString()===h)},g.isSame=function(e,t){var r=S(e);return this.startOf(t)<=r&&r<=this.endOf(t)},g.isAfter=function(e,t){return S(e)<this.startOf(t)},g.isBefore=function(e,t){return this.endOf(t)<S(e)},g.$g=function(e,t,r){return k.u(e)?this[t]:this.set(r,e)},g.unix=function(){return Math.floor(this.valueOf()/1e3)},g.valueOf=function(){return this.$d.getTime()},g.startOf=function(e,t){var r=this,n=!!k.u(t)||t,l=k.p(e),h=function(e,t){var o=k.w(r.$u?Date.UTC(r.$y,t,e):new Date(r.$y,t,e),r);return n?o:o.endOf(u)},p=function(e,t){return k.w(r.toDate()[e].apply(r.toDate("s"),(n?[0,0,0,0]:[23,59,59,999]).slice(t)),r)},v=this.$W,y=this.$M,g=this.$D,b="set"+(this.$u?"UTC":"");switch(l){case f:return n?h(1,0):h(31,11);case s:return n?h(1,y):h(0,y+1);case c:var m=this.$locale().weekStart||0,w=(v<m?v+7:v)-m;return h(n?g-w:g+(6-w),y);case u:case d:return p(b+"Hours",0);case a:return p(b+"Minutes",1);case i:return p(b+"Seconds",2);case o:return p(b+"Milliseconds",3);default:return this.clone()}},g.endOf=function(e){return this.startOf(e,!1)},g.$set=function(e,t){var r,c=k.p(e),l="set"+(this.$u?"UTC":""),h=(r={},r[u]=l+"Date",r[d]=l+"Date",r[s]=l+"Month",r[f]=l+"FullYear",r[a]=l+"Hours",r[i]=l+"Minutes",r[o]=l+"Seconds",r[n]=l+"Milliseconds",r)[c],p=c===u?this.$D+(t-this.$W):t;if(c===s||c===f){var v=this.clone().set(d,1);v.$d[h](p),v.init(),this.$d=v.set(d,Math.min(this.$D,v.daysInMonth())).$d}else h&&this.$d[h](p);return this.init(),this},g.set=function(e,t){return this.clone().$set(e,t)},g.get=function(e){return this[k.p(e)]()},g.add=function(n,l){var d,h=this;n=Number(n);var p=k.p(l),v=function(e){var t=S(h);return k.w(t.date(t.date()+Math.round(e*n)),h)};if(p===s)return this.set(s,this.$M+n);if(p===f)return this.set(f,this.$y+n);if(p===u)return v(1);if(p===c)return v(7);var y=(d={},d[i]=t,d[a]=r,d[o]=e,d)[p]||1,g=this.$d.getTime()+n*y;return k.w(g,this)},g.subtract=function(e,t){return this.add(-1*e,t)},g.format=function(e){var t=this,r=this.$locale();if(!this.isValid())return r.invalidDate||h;var n=e||"YYYY-MM-DDTHH:mm:ssZ",o=k.z(this),i=this.$H,a=this.$m,u=this.$M,c=r.weekdays,s=r.months,l=r.meridiem,f=function(e,r,o,i){return e&&(e[r]||e(t,n))||o[r].slice(0,i)},d=function(e){return k.s(i%12||12,e,"0")},p=l||function(e,t,r){var n=e<12?"AM":"PM";return r?n.toLowerCase():n};return n.replace(v,(function(e,n){return n||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return k.s(t.$y,4,"0");case"M":return u+1;case"MM":return k.s(u+1,2,"0");case"MMM":return f(r.monthsShort,u,s,3);case"MMMM":return f(s,u);case"D":return t.$D;case"DD":return k.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return f(r.weekdaysMin,t.$W,c,2);case"ddd":return f(r.weekdaysShort,t.$W,c,3);case"dddd":return c[t.$W];case"H":return String(i);case"HH":return k.s(i,2,"0");case"h":return d(1);case"hh":return d(2);case"a":return p(i,a,!0);case"A":return p(i,a,!1);case"m":return String(a);case"mm":return k.s(a,2,"0");case"s":return String(t.$s);case"ss":return k.s(t.$s,2,"0");case"SSS":return k.s(t.$ms,3,"0");case"Z":return o}return null}(e)||o.replace(":","")}))},g.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},g.diff=function(n,d,h){var p,v=this,y=k.p(d),g=S(n),b=(g.utcOffset()-this.utcOffset())*t,m=this-g,w=function(){return k.m(v,g)};switch(y){case f:p=w()/12;break;case s:p=w();break;case l:p=w()/3;break;case c:p=(m-b)/6048e5;break;case u:p=(m-b)/864e5;break;case a:p=m/r;break;case i:p=m/t;break;case o:p=m/e;break;default:p=m}return h?p:k.a(p)},g.daysInMonth=function(){return this.endOf(s).$D},g.$locale=function(){return w[this.$L]},g.locale=function(e,t){if(!e)return this.$L;var r=this.clone(),n=O(e,t,!0);return n&&(r.$L=n),r},g.clone=function(){return k.w(this.$d,this)},g.toDate=function(){return new Date(this.valueOf())},g.toJSON=function(){return this.isValid()?this.toISOString():null},g.toISOString=function(){return this.$d.toISOString()},g.toString=function(){return this.$d.toUTCString()},y}(),T=A.prototype;return S.prototype=T,[["$ms",n],["$s",o],["$m",i],["$H",a],["$W",u],["$M",s],["$y",f],["$D",d]].forEach((function(e){T[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),S.extend=function(e,t){return e.$i||(e(t,A,S),e.$i=!0),S},S.locale=O,S.isDayjs=_,S.unix=function(e){return S(1e3*e)},S.en=w[m],S.Ls=w,S.p={},S}()}(c);var s=u(c.exports),l=Array.isArray,f="object"==typeof global&&global&&global.Object===Object&&global,d="object"==typeof self&&self&&self.Object===Object&&self,h=f||d||Function("return this")(),p=h.Symbol,v=Object.prototype,y=v.hasOwnProperty,g=v.toString,b=p?p.toStringTag:void 0;var m=Object.prototype.toString;var w="[object Null]",j="[object Undefined]",_=p?p.toStringTag:void 0;function O(e){return null==e?void 0===e?j:w:_&&_ in Object(e)?function(e){var t=y.call(e,b),r=e[b];try{e[b]=void 0;var n=!0}catch(e){}var o=g.call(e);return n&&(t?e[b]=r:delete e[b]),o}(e):function(e){return m.call(e)}(e)}function S(e){return null!=e&&"object"==typeof e}var k="[object Symbol]";function A(e){return"symbol"==typeof e||S(e)&&O(e)==k}var T=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,x=/^\w*$/;function $(e,t){if(l(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!A(e))||(x.test(e)||!T.test(e)||null!=t&&e in Object(t))}function I(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var M="[object AsyncFunction]",P="[object Function]",E="[object GeneratorFunction]",D="[object Proxy]";function U(e){if(!I(e))return!1;var t=O(e);return t==P||t==E||t==M||t==D}var N,B=h["__core-js_shared__"],C=(N=/[^.]+$/.exec(B&&B.keys&&B.keys.IE_PROTO||""))?"Symbol(src)_1."+N:"";var R=Function.prototype.toString;function F(e){if(null!=e){try{return R.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var W=/^\[object .+?Constructor\]$/,H=Function.prototype,G=Object.prototype,L=H.toString,z=G.hasOwnProperty,Y=RegExp("^"+L.call(z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function q(e){return!(!I(e)||(t=e,C&&C in t))&&(U(e)?Y:W).test(F(e));var t}function J(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return q(r)?r:void 0}var V=J(Object,"create");var Z=Object.prototype.hasOwnProperty;var K=Object.prototype.hasOwnProperty;function X(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Q(e,t){return e===t||e!=e&&t!=t}function ee(e,t){for(var r=e.length;r--;)if(Q(e[r][0],t))return r;return-1}X.prototype.clear=function(){this.__data__=V?V(null):{},this.size=0},X.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},X.prototype.get=function(e){var t=this.__data__;if(V){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return Z.call(t,e)?t[e]:void 0},X.prototype.has=function(e){var t=this.__data__;return V?void 0!==t[e]:K.call(t,e)},X.prototype.set=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=V&&void 0===t?"__lodash_hash_undefined__":t,this};var te=Array.prototype.splice;function re(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}re.prototype.clear=function(){this.__data__=[],this.size=0},re.prototype.delete=function(e){var t=this.__data__,r=ee(t,e);return!(r<0)&&(r==t.length-1?t.pop():te.call(t,r,1),--this.size,!0)},re.prototype.get=function(e){var t=this.__data__,r=ee(t,e);return r<0?void 0:t[r][1]},re.prototype.has=function(e){return ee(this.__data__,e)>-1},re.prototype.set=function(e,t){var r=this.__data__,n=ee(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this};var ne=J(h,"Map");function oe(e,t){var r,n,o=e.__data__;return("string"==(n=typeof(r=t))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==r:null===r)?o["string"==typeof t?"string":"hash"]:o.map}function ie(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}ie.prototype.clear=function(){this.size=0,this.__data__={hash:new X,map:new(ne||re),string:new X}},ie.prototype.delete=function(e){var t=oe(this,e).delete(e);return this.size-=t?1:0,t},ie.prototype.get=function(e){return oe(this,e).get(e)},ie.prototype.has=function(e){return oe(this,e).has(e)},ie.prototype.set=function(e,t){var r=oe(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this};var ae="Expected a function";function ue(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(ae);var r=function(){var n=arguments,o=t?t.apply(this,n):n[0],i=r.cache;if(i.has(o))return i.get(o);var a=e.apply(this,n);return r.cache=i.set(o,a)||i,a};return r.cache=new(ue.Cache||ie),r}ue.Cache=ie;var ce,se,le,fe=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,de=/\\(\\)?/g,he=(ce=function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(fe,(function(e,r,n,o){t.push(n?o.replace(de,"$1"):r||e)})),t},se=ue(ce,(function(e){return 500===le.size&&le.clear(),e})),le=se.cache,se),pe=he;function ve(e,t){for(var r=-1,n=null==e?0:e.length,o=Array(n);++r<n;)o[r]=t(e[r],r,e);return o}var ye=1/0,ge=p?p.prototype:void 0,be=ge?ge.toString:void 0;function me(e){if("string"==typeof e)return e;if(l(e))return ve(e,me)+"";if(A(e))return be?be.call(e):"";var t=e+"";return"0"==t&&1/e==-ye?"-0":t}function we(e){return null==e?"":me(e)}function je(e,t){return l(e)?e:$(e,t)?[e]:pe(we(e))}var _e=1/0;function Oe(e){if("string"==typeof e||A(e))return e;var t=e+"";return"0"==t&&1/e==-_e?"-0":t}function Se(e,t){for(var r=0,n=(t=je(t,e)).length;null!=e&&r<n;)e=e[Oe(t[r++])];return r&&r==n?e:void 0}function ke(e,t,r){var n=null==e?void 0:Se(e,t);return void 0===n?r:n}function Ae(e,t){for(var r=-1,n=null==e?0:e.length;++r<n&&!1!==t(e[r],r,e););return e}var Te,xe=function(e,t,r){for(var n=-1,o=Object(e),i=r(e),a=i.length;a--;){var u=i[Te?a:++n];if(!1===t(o[u],u,o))break}return e};function $e(e){return S(e)&&"[object Arguments]"==O(e)}var Ie=Object.prototype,Me=Ie.hasOwnProperty,Pe=Ie.propertyIsEnumerable,Ee=$e(function(){return arguments}())?$e:function(e){return S(e)&&Me.call(e,"callee")&&!Pe.call(e,"callee")},De=Ee;var Ue="object"==typeof exports&&exports&&!exports.nodeType&&exports,Ne=Ue&&"object"==typeof module&&module&&!module.nodeType&&module,Be=Ne&&Ne.exports===Ue?h.Buffer:void 0,Ce=(Be?Be.isBuffer:void 0)||function(){return!1},Re=9007199254740991,Fe=/^(?:0|[1-9]\d*)$/;function We(e,t){var r=typeof e;return!!(t=null==t?Re:t)&&("number"==r||"symbol"!=r&&Fe.test(e))&&e>-1&&e%1==0&&e<t}var He=9007199254740991;function Ge(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=He}var Le={};function ze(e){return function(t){return e(t)}}Le["[object Float32Array]"]=Le["[object Float64Array]"]=Le["[object Int8Array]"]=Le["[object Int16Array]"]=Le["[object Int32Array]"]=Le["[object Uint8Array]"]=Le["[object Uint8ClampedArray]"]=Le["[object Uint16Array]"]=Le["[object Uint32Array]"]=!0,Le["[object Arguments]"]=Le["[object Array]"]=Le["[object ArrayBuffer]"]=Le["[object Boolean]"]=Le["[object DataView]"]=Le["[object Date]"]=Le["[object Error]"]=Le["[object Function]"]=Le["[object Map]"]=Le["[object Number]"]=Le["[object Object]"]=Le["[object RegExp]"]=Le["[object Set]"]=Le["[object String]"]=Le["[object WeakMap]"]=!1;var Ye="object"==typeof exports&&exports&&!exports.nodeType&&exports,qe=Ye&&"object"==typeof module&&module&&!module.nodeType&&module,Je=qe&&qe.exports===Ye&&f.process,Ve=function(){try{var e=qe&&qe.require&&qe.require("util").types;return e||Je&&Je.binding&&Je.binding("util")}catch(e){}}(),Ze=Ve&&Ve.isTypedArray,Ke=Ze?ze(Ze):function(e){return S(e)&&Ge(e.length)&&!!Le[O(e)]},Xe=Object.prototype.hasOwnProperty;function Qe(e,t){var r=l(e),n=!r&&De(e),o=!r&&!n&&Ce(e),i=!r&&!n&&!o&&Ke(e),a=r||n||o||i,u=a?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],c=u.length;for(var s in e)!t&&!Xe.call(e,s)||a&&("length"==s||o&&("offset"==s||"parent"==s)||i&&("buffer"==s||"byteLength"==s||"byteOffset"==s)||We(s,c))||u.push(s);return u}var et=Object.prototype;function tt(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||et)}function rt(e,t){return function(r){return e(t(r))}}var nt=rt(Object.keys,Object),ot=Object.prototype.hasOwnProperty;function it(e){if(!tt(e))return nt(e);var t=[];for(var r in Object(e))ot.call(e,r)&&"constructor"!=r&&t.push(r);return t}function at(e){return null!=e&&Ge(e.length)&&!U(e)}function ut(e){return at(e)?Qe(e):it(e)}var ct=function(e,t){return function(r,n){if(null==r)return r;if(!at(r))return e(r,n);for(var o=r.length,i=t?o:-1,a=Object(r);(t?i--:++i<o)&&!1!==n(a[i],i,a););return r}}((function(e,t){return e&&xe(e,t,ut)})),st=ct;function lt(e){return e}function ft(e,t){var r;return(l(e)?Ae:st)(e,"function"==typeof(r=t)?r:lt)}var dt=J(h,"DataView"),ht=J(h,"Promise"),pt=J(h,"Set"),vt=J(h,"WeakMap"),yt="[object Map]",gt="[object Promise]",bt="[object Set]",mt="[object WeakMap]",wt="[object DataView]",jt=F(dt),_t=F(ne),Ot=F(ht),St=F(pt),kt=F(vt),At=O;(dt&&At(new dt(new ArrayBuffer(1)))!=wt||ne&&At(new ne)!=yt||ht&&At(ht.resolve())!=gt||pt&&At(new pt)!=bt||vt&&At(new vt)!=mt)&&(At=function(e){var t=O(e),r="[object Object]"==t?e.constructor:void 0,n=r?F(r):"";if(n)switch(n){case jt:return wt;case _t:return yt;case Ot:return gt;case St:return bt;case kt:return mt}return t});var Tt=At,xt="[object String]";function $t(e){return function(t){return null==t?void 0:t[e]}}var It=$t("length"),Mt=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");function Pt(e){return Mt.test(e)}var Et="\\ud800-\\udfff",Dt="["+Et+"]",Ut="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Nt="\\ud83c[\\udffb-\\udfff]",Bt="[^"+Et+"]",Ct="(?:\\ud83c[\\udde6-\\uddff]){2}",Rt="[\\ud800-\\udbff][\\udc00-\\udfff]",Ft="(?:"+Ut+"|"+Nt+")"+"?",Wt="[\\ufe0e\\ufe0f]?",Ht=Wt+Ft+("(?:\\u200d(?:"+[Bt,Ct,Rt].join("|")+")"+Wt+Ft+")*"),Gt="(?:"+[Bt+Ut+"?",Ut,Ct,Rt,Dt].join("|")+")",Lt=RegExp(Nt+"(?="+Nt+")|"+Gt+Ht,"g");function zt(e){return Pt(e)?function(e){for(var t=Lt.lastIndex=0;Lt.test(e);)++t;return t}(e):It(e)}var Yt="[object Map]",qt="[object Set]";function Jt(e){if(null==e)return 0;if(at(e))return"string"==typeof(t=e)||!l(t)&&S(t)&&O(t)==xt?zt(e):e.length;var t,r=Tt(e);return r==Yt||r==qt?e.size:it(e).length}function Vt(e){return"[object Object]"===Object.prototype.toString.call(e)}function Zt(e){if(Vt(e)){for(let t in e)return!0;return!1}return!1}function Kt(e){return"[object String]"===Object.prototype.toString.call(e)}function Xt(e){return!(!Kt(e)||""===e)}var Qt=/\s/;var er=/^\s+/;function tr(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&Qt.test(e.charAt(t)););return t}(e)+1).replace(er,""):e}var rr=NaN,nr=/^[-+]0x[0-9a-f]+$/i,or=/^0b[01]+$/i,ir=/^0o[0-7]+$/i,ar=parseInt;function ur(e){if("number"==typeof e)return e;if(A(e))return rr;if(I(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=I(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=tr(e);var r=or.test(e);return r||ir.test(e)?ar(e.slice(2),r?2:8):nr.test(e)?rr:+e}var cr=1/0,sr=17976931348623157e292;function lr(e){return e?(e=ur(e))===cr||e===-cr?(e<0?-1:1)*sr:e==e?e:0:0===e?e:0}function fr(e){var t=lr(e),r=t%1;return t==t?r?t-r:t:0}function dr(e){return e!=e}function hr(e){let t=!1;if(Xt(e))t=!isNaN(Number(e));else if(function(e){return"[object Number]"===Object.prototype.toString.call(e)}(e)){if(dr(e))return!1;t=!0}return t}function pr(e){if(!hr(e))return 0;return lr(e)}function vr(e){return!!hr(e)&&(e=pr(e),"number"==typeof(t=e)&&t==fr(t));var t}var yr=h.isFinite,gr=Math.min;var br=function(e){var t=Math[e];return function(e,r){if(e=ur(e),(r=null==r?0:gr(fr(r),292))&&yr(e)){var n=(we(e)+"e").split("e");return+((n=(we(t(n[0]+"e"+(+n[1]+r)))+"e").split("e"))[0]+"e"+(+n[1]-r))}return t(e)}}("round"),mr=br;function wr(e){if(!hr(e))return 0;e=pr(e);let t=mr(e);return"0"===String(t)?0:t}function jr(e){if(!vr(e))return!1;return wr(e)>0}function _r(e){return"[object Array]"===Object.prototype.toString.call(e)}function Or(e){return"[object Undefined]"===Object.prototype.toString.call(e)}function Sr(e){if(Vt(e)){for(let t in e)return!1;return!0}return!1}function kr(e){return!!Or(e)||(!!function(e){return"[object Null]"===Object.prototype.toString.call(e)}(e)||(!!Sr(e)||(!!function(e){return!(!Kt(e)||""!==e)}(e)||(!!function(e){return!!_r(e)&&0===e.length}(e)||!!dr(e)))))}function Ar(e){return!!_r(e)&&(0!==e.length&&(1!==e.length||!kr(e[0])))}function Tr(e){let t=Object.prototype.toString.call(e);return"[object Function]"===t||"[object AsyncFunction]"===t}function xr(e){let t,r=Object.prototype.toString.call(e);if(t="[object Promise]"===r,t)return!0;if("[object Function]"!==r)return!1;try{t="function"!=typeof e.subscribe&&"function"==typeof e.then}catch(e){}return t}function $r(e){if(!Xt(e))return{};let t={};try{t=JSON.parse(e)}catch(e){t={}}return t}function Ir(e){if(!vr(e))return!1;return wr(e)>=0}function Mr(e,t){return Xt(e)&&Ir(t)?0===(t=wr(t))?"":e.substring(0,t):""}function Pr(){let e,t,r=new Promise((function(){e=arguments[0],t=arguments[1]}));return r.resolve=e,r.reject=t,r}let Er=function(e){if(!Tr(e))throw new Error("fn is not a function");return function(){let t=Pr(),r=null,n=null;try{r=e.apply(this,arguments)}catch(e){n=e}return null!==n?t.resolve({state:"error",msg:n}):xr(r)?r.then((e=>{t.resolve({state:"success",msg:e})})).catch((e=>{"cancelled"===ke(e,"reason")?t.resolve({state:"cancelled",msg:""}):t.resolve({state:"error",msg:e})})):t.resolve({state:"success",msg:r}),t}};function Dr(e,t,r){var n=-1,o=e.length;t<0&&(t=-t>o?0:o+t),(r=r>o?o:r)<0&&(r+=o),o=t>r?0:r-t>>>0,t>>>=0;for(var i=Array(o);++n<o;)i[n]=e[n+t];return i}function Ur(e,t){let r=Pr();if(!_r(e)&&!Vt(e))return r.reject("rs is not an array or object"),r;let n=!1;if(Vt(e)){n=!0;let t=[];ft(e,((e,r)=>{t.push({k:r,v:e})})),e=t}Tr(t)||(t=function(e){return e});let o=-1,i=[];return e.reduce((function(e,r){return e.then((function(e){i.push(e),o+=1;let a=o,u=r;return n&&(a=r.k,u=r.v),Tr(t)?t(u,a):u}))}),Promise.resolve()).then((function(e){var t,n,o,a;i.push(e),a=null==(t=i)?0:t.length,i=a?Dr(t,(n=o||void 0===n?1:fr(n))<0?0:n,a):[],r.resolve(i)})).catch((function(e){r.reject(e)})),r}function Nr(e){return!!t.existsSync(e)&&(!t.lstatSync(e).isDirectory()&&!t.lstatSync(e).isSymbolicLink())}function Br(e,t,r){if(!Xt(e))return"";if(!Xt(t))return"";if(!Kt(r))return"";return String(e).replaceAll(t,r)}var Cr="[object Boolean]";function Rr(e){return!0===(t=e)||!1===t||S(t)&&O(t)==Cr;var t}var Fr={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}function o(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,n,i,a){if("function"!=typeof n)throw new TypeError("The listener must be a function");var u=new o(n,i||e,a),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],u]:e._events[c].push(u):(e._events[c]=u,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function u(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),u.prototype.eventNames=function(){var e,n,o=[];if(0===this._eventsCount)return o;for(n in e=this._events)t.call(e,n)&&o.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},u.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,a=new Array(i);o<i;o++)a[o]=n[o].fn;return a},u.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},u.prototype.emit=function(e,t,n,o,i,a){var u=r?r+e:e;if(!this._events[u])return!1;var c,s,l=this._events[u],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,o),!0;case 5:return l.fn.call(l.context,t,n,o,i),!0;case 6:return l.fn.call(l.context,t,n,o,i,a),!0}for(s=1,c=new Array(f-1);s<f;s++)c[s-1]=arguments[s];l.fn.apply(l.context,c)}else{var d,h=l.length;for(s=0;s<h;s++)switch(l[s].once&&this.removeListener(e,l[s].fn,void 0,!0),f){case 1:l[s].fn.call(l[s].context);break;case 2:l[s].fn.call(l[s].context,t);break;case 3:l[s].fn.call(l[s].context,t,n);break;case 4:l[s].fn.call(l[s].context,t,n,o);break;default:if(!c)for(d=1,c=new Array(f-1);d<f;d++)c[d-1]=arguments[d];l[s].fn.apply(l[s].context,c)}}return!0},u.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},u.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},u.prototype.removeListener=function(e,t,n,o){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var u=this._events[i];if(u.fn)u.fn!==t||o&&!u.once||n&&u.context!==n||a(this,i);else{for(var c=0,s=[],l=u.length;c<l;c++)(u[c].fn!==t||o&&!u[c].once||n&&u[c].context!==n)&&s.push(u[c]);s.length?this._events[i]=1===s.length?s[0]:s:a(this,i)}return this},u.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&a(this,t)):(this._events=new n,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=r,u.EventEmitter=u,e.exports=u}(Fr);var Wr=u(Fr.exports);function Hr(){return new Wr}function Gr(e){var t=this.__data__=new re(e);this.size=t.size}Gr.prototype.clear=function(){this.__data__=new re,this.size=0},Gr.prototype.delete=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r},Gr.prototype.get=function(e){return this.__data__.get(e)},Gr.prototype.has=function(e){return this.__data__.has(e)},Gr.prototype.set=function(e,t){var r=this.__data__;if(r instanceof re){var n=r.__data__;if(!ne||n.length<199)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new ie(n)}return r.set(e,t),this.size=r.size,this};function Lr(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new ie;++t<r;)this.add(e[t])}function zr(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}function Yr(e,t){return e.has(t)}Lr.prototype.add=Lr.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},Lr.prototype.has=function(e){return this.__data__.has(e)};var qr=1,Jr=2;function Vr(e,t,r,n,o,i){var a=r&qr,u=e.length,c=t.length;if(u!=c&&!(a&&c>u))return!1;var s=i.get(e),l=i.get(t);if(s&&l)return s==t&&l==e;var f=-1,d=!0,h=r&Jr?new Lr:void 0;for(i.set(e,t),i.set(t,e);++f<u;){var p=e[f],v=t[f];if(n)var y=a?n(v,p,f,t,e,i):n(p,v,f,e,t,i);if(void 0!==y){if(y)continue;d=!1;break}if(h){if(!zr(t,(function(e,t){if(!Yr(h,t)&&(p===e||o(p,e,r,n,i)))return h.push(t)}))){d=!1;break}}else if(p!==v&&!o(p,v,r,n,i)){d=!1;break}}return i.delete(e),i.delete(t),d}var Zr=h.Uint8Array;function Kr(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}function Xr(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}var Qr=1,en=2,tn="[object Boolean]",rn="[object Date]",nn="[object Error]",on="[object Map]",an="[object Number]",un="[object RegExp]",cn="[object Set]",sn="[object String]",ln="[object Symbol]",fn="[object ArrayBuffer]",dn="[object DataView]",hn=p?p.prototype:void 0,pn=hn?hn.valueOf:void 0;function vn(e,t){for(var r=-1,n=t.length,o=e.length;++r<n;)e[o+r]=t[r];return e}function yn(e,t,r){var n=t(e);return l(e)?n:vn(n,r(e))}function gn(e,t){for(var r=-1,n=null==e?0:e.length,o=0,i=[];++r<n;){var a=e[r];t(a,r,e)&&(i[o++]=a)}return i}function bn(){return[]}var mn=Object.prototype.propertyIsEnumerable,wn=Object.getOwnPropertySymbols,jn=wn?function(e){return null==e?[]:(e=Object(e),gn(wn(e),(function(t){return mn.call(e,t)})))}:bn;function _n(e){return yn(e,ut,jn)}var On=1,Sn=Object.prototype.hasOwnProperty;var kn=1,An="[object Arguments]",Tn="[object Array]",xn="[object Object]",$n=Object.prototype.hasOwnProperty;function In(e,t,r,n,o,i){var a=l(e),u=l(t),c=a?Tn:Tt(e),s=u?Tn:Tt(t),f=(c=c==An?xn:c)==xn,d=(s=s==An?xn:s)==xn,h=c==s;if(h&&Ce(e)){if(!Ce(t))return!1;a=!0,f=!1}if(h&&!f)return i||(i=new Gr),a||Ke(e)?Vr(e,t,r,n,o,i):function(e,t,r,n,o,i,a){switch(r){case dn:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case fn:return!(e.byteLength!=t.byteLength||!i(new Zr(e),new Zr(t)));case tn:case rn:case an:return Q(+e,+t);case nn:return e.name==t.name&&e.message==t.message;case un:case sn:return e==t+"";case on:var u=Kr;case cn:var c=n&Qr;if(u||(u=Xr),e.size!=t.size&&!c)return!1;var s=a.get(e);if(s)return s==t;n|=en,a.set(e,t);var l=Vr(u(e),u(t),n,o,i,a);return a.delete(e),l;case ln:if(pn)return pn.call(e)==pn.call(t)}return!1}(e,t,c,r,n,o,i);if(!(r&kn)){var p=f&&$n.call(e,"__wrapped__"),v=d&&$n.call(t,"__wrapped__");if(p||v){var y=p?e.value():e,g=v?t.value():t;return i||(i=new Gr),o(y,g,r,n,i)}}return!!h&&(i||(i=new Gr),function(e,t,r,n,o,i){var a=r&On,u=_n(e),c=u.length;if(c!=_n(t).length&&!a)return!1;for(var s=c;s--;){var l=u[s];if(!(a?l in t:Sn.call(t,l)))return!1}var f=i.get(e),d=i.get(t);if(f&&d)return f==t&&d==e;var h=!0;i.set(e,t),i.set(t,e);for(var p=a;++s<c;){var v=e[l=u[s]],y=t[l];if(n)var g=a?n(y,v,l,t,e,i):n(v,y,l,e,t,i);if(!(void 0===g?v===y||o(v,y,r,n,i):g)){h=!1;break}p||(p="constructor"==l)}if(h&&!p){var b=e.constructor,m=t.constructor;b==m||!("constructor"in e)||!("constructor"in t)||"function"==typeof b&&b instanceof b&&"function"==typeof m&&m instanceof m||(h=!1)}return i.delete(e),i.delete(t),h}(e,t,r,n,o,i))}function Mn(e,t,r,n,o){return e===t||(null==e||null==t||!S(e)&&!S(t)?e!=e&&t!=t:In(e,t,r,n,Mn,o))}var Pn=1,En=2;function Dn(e){return e==e&&!I(e)}function Un(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}}function Nn(e){var t=function(e){for(var t=ut(e),r=t.length;r--;){var n=t[r],o=e[n];t[r]=[n,o,Dn(o)]}return t}(e);return 1==t.length&&t[0][2]?Un(t[0][0],t[0][1]):function(r){return r===e||function(e,t,r,n){var o=r.length,i=o,a=!n;if(null==e)return!i;for(e=Object(e);o--;){var u=r[o];if(a&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++o<i;){var c=(u=r[o])[0],s=e[c],l=u[1];if(a&&u[2]){if(void 0===s&&!(c in e))return!1}else{var f=new Gr;if(n)var d=n(s,l,c,e,t,f);if(!(void 0===d?Mn(l,s,Pn|En,n,f):d))return!1}}return!0}(r,e,t)}}function Bn(e,t){return null!=e&&t in Object(e)}function Cn(e,t){return null!=e&&function(e,t,r){for(var n=-1,o=(t=je(t,e)).length,i=!1;++n<o;){var a=Oe(t[n]);if(!(i=null!=e&&r(e,a)))break;e=e[a]}return i||++n!=o?i:!!(o=null==e?0:e.length)&&Ge(o)&&We(a,o)&&(l(e)||De(e))}(e,t,Bn)}var Rn=1,Fn=2;function Wn(e){return $(e)?$t(Oe(e)):function(e){return function(t){return Se(t,e)}}(e)}function Hn(e){return"function"==typeof e?e:null==e?lt:"object"==typeof e?l(e)?function(e,t){return $(e)&&Dn(t)?Un(Oe(e),t):function(r){var n=ke(r,e);return void 0===n&&n===t?Cn(r,e):Mn(t,n,Rn|Fn)}}(e[0],e[1]):Nn(e):Wn(e)}function Gn(e,t){var r=-1,n=at(e)?Array(e.length):[];return st(e,(function(e,o,i){n[++r]=t(e,o,i)})),n}function Ln(e,t){return(l(e)?ve:Gn)(e,Hn(t))}var zn=function(){try{var e=J(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),Yn=zn;function qn(e,t,r){"__proto__"==t&&Yn?Yn(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}var Jn=Object.prototype.hasOwnProperty;function Vn(e,t,r){var n=e[t];Jn.call(e,t)&&Q(n,r)&&(void 0!==r||t in e)||qn(e,t,r)}function Zn(e,t,r,n){var o=!r;r||(r={});for(var i=-1,a=t.length;++i<a;){var u=t[i],c=n?n(r[u],e[u],u,r,e):void 0;void 0===c&&(c=e[u]),o?qn(r,u,c):Vn(r,u,c)}return r}var Kn=Object.prototype.hasOwnProperty;function Xn(e){if(!I(e))return function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t}(e);var t=tt(e),r=[];for(var n in e)("constructor"!=n||!t&&Kn.call(e,n))&&r.push(n);return r}function Qn(e){return at(e)?Qe(e,!0):Xn(e)}var eo="object"==typeof exports&&exports&&!exports.nodeType&&exports,to=eo&&"object"==typeof module&&module&&!module.nodeType&&module,ro=to&&to.exports===eo?h.Buffer:void 0,no=ro?ro.allocUnsafe:void 0;function oo(e,t){if(t)return e.slice();var r=e.length,n=no?no(r):new e.constructor(r);return e.copy(n),n}function io(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t}var ao=rt(Object.getPrototypeOf,Object),uo=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)vn(t,jn(e)),e=ao(e);return t}:bn,co=uo;function so(e){return yn(e,Qn,co)}var lo=Object.prototype.hasOwnProperty;function fo(e){var t=new e.constructor(e.byteLength);return new Zr(t).set(new Zr(e)),t}var ho=/\w*$/;var po=p?p.prototype:void 0,vo=po?po.valueOf:void 0;function yo(e,t){var r=t?fo(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}var go="[object Boolean]",bo="[object Date]",mo="[object Map]",wo="[object Number]",jo="[object RegExp]",_o="[object Set]",Oo="[object String]",So="[object Symbol]",ko="[object ArrayBuffer]",Ao="[object DataView]",To="[object Float32Array]",xo="[object Float64Array]",$o="[object Int8Array]",Io="[object Int16Array]",Mo="[object Int32Array]",Po="[object Uint8Array]",Eo="[object Uint8ClampedArray]",Do="[object Uint16Array]",Uo="[object Uint32Array]";function No(e,t,r){var n,o=e.constructor;switch(t){case ko:return fo(e);case go:case bo:return new o(+e);case Ao:return function(e,t){var r=t?fo(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,r);case To:case xo:case $o:case Io:case Mo:case Po:case Eo:case Do:case Uo:return yo(e,r);case mo:return new o;case wo:case Oo:return new o(e);case jo:return function(e){var t=new e.constructor(e.source,ho.exec(e));return t.lastIndex=e.lastIndex,t}(e);case _o:return new o;case So:return n=e,vo?Object(vo.call(n)):{}}}var Bo=Object.create,Co=function(){function e(){}return function(t){if(!I(t))return{};if(Bo)return Bo(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}(),Ro=Co;function Fo(e){return"function"!=typeof e.constructor||tt(e)?{}:Ro(ao(e))}var Wo=Ve&&Ve.isMap,Ho=Wo?ze(Wo):function(e){return S(e)&&"[object Map]"==Tt(e)};var Go=Ve&&Ve.isSet,Lo=Go?ze(Go):function(e){return S(e)&&"[object Set]"==Tt(e)},zo=1,Yo=2,qo=4,Jo="[object Arguments]",Vo="[object Function]",Zo="[object GeneratorFunction]",Ko="[object Object]",Xo={};function Qo(e,t,r,n,o,i){var a,u=t&zo,c=t&Yo,s=t&qo;if(r&&(a=o?r(e,n,o,i):r(e)),void 0!==a)return a;if(!I(e))return e;var f=l(e);if(f){if(a=function(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&lo.call(e,"index")&&(r.index=e.index,r.input=e.input),r}(e),!u)return io(e,a)}else{var d=Tt(e),h=d==Vo||d==Zo;if(Ce(e))return oo(e,u);if(d==Ko||d==Jo||h&&!o){if(a=c||h?{}:Fo(e),!u)return c?function(e,t){return Zn(e,co(e),t)}(e,function(e,t){return e&&Zn(t,Qn(t),e)}(a,e)):function(e,t){return Zn(e,jn(e),t)}(e,function(e,t){return e&&Zn(t,ut(t),e)}(a,e))}else{if(!Xo[d])return o?e:{};a=No(e,d,u)}}i||(i=new Gr);var p=i.get(e);if(p)return p;i.set(e,a),Lo(e)?e.forEach((function(n){a.add(Qo(n,t,r,n,e,i))})):Ho(e)&&e.forEach((function(n,o){a.set(o,Qo(n,t,r,o,e,i))}));var v=f?void 0:(s?c?so:_n:c?Qn:ut)(e);return Ae(v||e,(function(n,o){v&&(n=e[o=n]),Vn(a,o,Qo(n,t,r,o,e,i))})),a}Xo[Jo]=Xo["[object Array]"]=Xo["[object ArrayBuffer]"]=Xo["[object DataView]"]=Xo["[object Boolean]"]=Xo["[object Date]"]=Xo["[object Float32Array]"]=Xo["[object Float64Array]"]=Xo["[object Int8Array]"]=Xo["[object Int16Array]"]=Xo["[object Int32Array]"]=Xo["[object Map]"]=Xo["[object Number]"]=Xo[Ko]=Xo["[object RegExp]"]=Xo["[object Set]"]=Xo["[object String]"]=Xo["[object Symbol]"]=Xo["[object Uint8Array]"]=Xo["[object Uint8ClampedArray]"]=Xo["[object Uint16Array]"]=Xo["[object Uint32Array]"]=!0,Xo["[object Error]"]=Xo[Vo]=Xo["[object WeakMap]"]=!1;var ei=1,ti=4;function ri(e){return Qo(e,ei|ti)}function ni(e,t){return!!Vt(e)&&(!(!Xt(t)&&!hr(t))&&t in e)}function oi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Hr(),r={},n=null,o=ke(e,"timeAlive");jr(o)||(o=1e4),o=wr(o);let i=ke(e,"timeDetect");return jr(i)||(i=50),i=wr(i),t.trigger=function(e,a){Xt(e)?(ni(r,e)||setTimeout((()=>{t.emit("message",{eventName:"enter",key:e,data:a,now:Jt(r)})}),1),r[e]={data:a,time:Date.now()},null===n&&(n=setInterval((()=>{ft(r,((e,n)=>{if(Date.now()-e.time>o){let e=ri(r[n]);delete r[n],t.emit("message",{eventName:"leave",key:n,data:e.data,now:Jt(r)})}})),Zt(r)||(clearInterval(n),n=null)}),i))):console.log("trigger need key")},t.get=function(){let e=[];return ft(r,((t,r)=>{e.push({key:r,data:t.data})})),e=ri(e),e},t}function ii(e){return"[object ArrayBuffer]"===Object.prototype.toString.call(e)}function ai(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)}function ui(e){return"[object Uint16Array]"===Object.prototype.toString.call(e)}function ci(e){if(!(ii(e)||(t=e,"[object Blob]"===Object.prototype.toString.call(t))||ai(e)||ui(e)))return null;var t;try{if(e.byteLength)return e.byteLength}catch(e){}try{if(e.length)return e.length}catch(e){}try{if(e.size)return e.size}catch(e){}return null}var si="[object Object]",li=Function.prototype,fi=Object.prototype,di=li.toString,hi=fi.hasOwnProperty,pi=di.call(Object);function vi(e){if(!S(e)||O(e)!=si)return!1;var t=ao(e);if(null===t)return!0;var r=hi.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&di.call(r)==pi}var yi="[object DOMException]",gi="[object Error]";function bi(e){if(!Vt(e))return{results:"",binarys:[]};if(Sr(e))return{results:"",binarys:[]};let t="",r=[];try{let n=-1;t=JSON.stringify(e,(function(e,t){if(ai(t)){n+=1;let e=`[Uint8Array]::${n}`;return r.push(t),e}if(ui(t)){n+=1;let e=`[Uint16Array]::${n}`;return r.push(t),e}if(ii(t)){n+=1;let e=`[ArrayBuffer]::${n}`;return r.push(t),e}return function(e){if(!S(e))return!1;var t=O(e);return t==gi||t==yi||"string"==typeof e.message&&"string"==typeof e.name&&!vi(e)}(t)&&(t=t.toString()),t}))}catch(e){}return{results:t,binarys:r}}var mi={exports:{}};var wi,ji={exports:{}};function _i(){return wi||(wi=1,function(e,t){var r;e.exports=(r=r||function(e,t){var r;if("undefined"!=typeof window&&window.crypto&&(r=window.crypto),"undefined"!=typeof self&&self.crypto&&(r=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(r=globalThis.crypto),!r&&"undefined"!=typeof window&&window.msCrypto&&(r=window.msCrypto),!r&&void 0!==a&&a.crypto&&(r=a.crypto),!r)try{r=require("crypto")}catch(e){}var n=function(){if(r){if("function"==typeof r.getRandomValues)try{return r.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof r.randomBytes)try{return r.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},o=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),i={},u=i.lib={},c=u.Base={extend:function(e){var t=o(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=u.WordArray=c.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length},toString:function(e){return(e||f).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,o=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<o;i++){var a=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=a<<24-(n+i)%4*8}else for(var u=0;u<o;u+=4)t[n+u>>>2]=r[u>>>2];return this.sigBytes+=o,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=c.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(n());return new s.init(t,e)}}),l=i.enc={},f=l.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],o=0;o<r;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new s.init(r,t/2)}},d=l.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],o=0;o<r;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push(String.fromCharCode(i))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(r,t)}},h=l.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},p=u.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=h.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,n=this._data,o=n.words,i=n.sigBytes,a=this.blockSize,u=i/(4*a),c=(u=t?e.ceil(u):e.max((0|u)-this._minBufferSize,0))*a,l=e.min(4*c,i);if(c){for(var f=0;f<c;f+=a)this._doProcessBlock(o,f);r=o.splice(0,c),n.sigBytes-=l}return new s.init(r,l)},clone:function(){var e=c.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});u.Hasher=p.extend({cfg:c.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new v.HMAC.init(e,r).finalize(t)}}});var v=i.algo={};return i}(Math),r)}(ji)),ji.exports}!function(e,t){e.exports=_i().enc.Utf8}(mi);var Oi=u(mi.exports),Si={exports:{}};!function(e,t){var r;e.exports=(r=_i(),function(){var e=r,t=e.lib.WordArray;function n(e,r,n){for(var o=[],i=0,a=0;a<r;a++)if(a%4){var u=n[e.charCodeAt(a-1)]<<a%4*2|n[e.charCodeAt(a)]>>>6-a%4*2;o[i>>>2]|=u<<24-i%4*8,i++}return t.create(o,i)}e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var o=[],i=0;i<r;i+=3)for(var a=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,u=0;u<4&&i+.75*u<r;u++)o.push(n.charAt(a>>>6*(3-u)&63));var c=n.charAt(64);if(c)for(;o.length%4;)o.push(c);return o.join("")},parse:function(e){var t=e.length,r=this._map,o=this._reverseMap;if(!o){o=this._reverseMap=[];for(var i=0;i<r.length;i++)o[r.charCodeAt(i)]=i}var a=r.charAt(64);if(a){var u=e.indexOf(a);-1!==u&&(t=u)}return n(e,t,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),r.enc.Base64)}(Si);var ki=u(Si.exports);function Ai(e){if(!Xt(e))return new Uint8Array;let t;try{t=function(e){if(!Kt(e))return new Uint8Array;let t=ki.parse(e),r=t.words,n=t.sigBytes,o=new Uint8Array(n);for(let e=0;e<n;e++){let t=r[e>>>2]>>>24-e%4*8&255;o[e]=t}return o}(function(e){if(!Xt(e))return"";let t=Oi.parse(e);return ki.stringify(t)}(e))}catch(e){return new Uint8Array}return t}function Ti(e,t){return function(e,t,r,n,o,i){if(!hr(e))return null;if(!ai(t))return null;if(!vr(r))return null;if(!Rr(n))return null;if(!vr(o))return null;if(!vr(i))return null;let a,u,c;e=pr(e);let s=8*i-o-1,l=(1<<s)-1,f=l>>1,d=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,h=n?i-1:0,p=n?-1:1,v=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(u=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-a))<1&&(a--,c*=2),(e+=a+f>=1?d/c:d*Math.pow(2,1-f))*c>=2&&(a++,c/=2),a+f>=l?(u=0,a=l):a+f>=1?(u=(e*c-1)*Math.pow(2,o),a+=f):(u=e*Math.pow(2,f-1)*Math.pow(2,o),a=0));o>=8;t[r+h]=255&u,h+=p,u/=256,o-=8);for(a=a<<o|u,s+=o;s>0;t[r+h]=255&a,h+=p,a/=256,s-=8);return t[r+h-p]|=128*v,null}(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,!(arguments.length>3&&void 0!==arguments[3])||arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:52,arguments.length>5&&void 0!==arguments[5]?arguments[5]:8)}function xi(e){let t=[],r=[];if(!Ar(e)&&!Zt(e))return null;let n=[],o=[];function i(e){n.push(ci(e)),o.push(e)}try{let a=bi(e);i(Ai(a.results)),ft(a.binarys,(e=>{i(e)}));let u=n,c=Ai(JSON.stringify(u)),s=new Uint8Array(8);Ti(ci(c),s),t.push(s),t.push(c),ft(o,(e=>{t.push(e)})),ft(t,(e=>{r=function(e,t){let r=ci(e),n=ci(t),o=new Uint8Array(r+n);return o.set(new Uint8Array(e),0),o.set(new Uint8Array(t),r),o}(r,e)}))}catch(e){return null}return r}function $i(e){return function(e,t,r,n,o){if(!ai(e))return null;if(!vr(t))return null;if(!Rr(r))return null;if(!vr(n))return null;if(!vr(o))return null;let i,a,u=8*o-n-1,c=(1<<u)-1,s=c>>1,l=-7,f=r?0:o-1,d=r?1:-1,h=e[t+f];for(f+=d,i=h&(1<<-l)-1,h>>=-l,l+=u;l>0;i=256*i+e[t+f],f+=d,l-=8);for(a=i&(1<<-l)-1,i>>=-l,l+=n;l>0;a=256*a+e[t+f],f+=d,l-=8);if(0===i)i=1-s;else{if(i===c)return a?NaN:1/0*(h?-1:1);a+=Math.pow(2,n),i-=s}return(h?-1:1)*a*Math.pow(2,i-n)}(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,!(arguments.length>2&&void 0!==arguments[2])||arguments[2],arguments.length>3&&void 0!==arguments[3]?arguments[3]:52,arguments.length>4&&void 0!==arguments[4]?arguments[4]:8)}var Ii={exports:{}};!function(e,t){var r;e.exports=(r=_i(),function(){if("function"==typeof ArrayBuffer){var e=r.lib.WordArray,t=e.init,n=e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var r=e.byteLength,n=[],o=0;o<r;o++)n[o>>>2]|=e[o]<<24-o%4*8;t.call(this,n,r)}else t.apply(this,arguments)};n.prototype=e}}(),r.lib.WordArray)}(Ii);var Mi=u(Ii.exports);function Pi(e){if(!ai(e))return"";let t;try{r=function(e){return ai(e)?Mi.create(e).toString(ki):""}(e),t=Xt(r)?ki.parse(r).toString(Oi):""}catch(e){return""}var r;return t}function Ei(e){let t=null;if(!ai(e))return null;try{let r=8,n=e.slice(0,r),o=e.slice(r,ci(e)),i=$i(n),a=o.slice(0,i),u=o.slice(i,ci(o)),c=Pi(a),s=function(e,t){let r=0,n=0,o=[];return ft(t,(t=>{n=r+t;let i=e.slice(r,n);r=n,o.push(i)})),o}(u,JSON.parse(c));t=function(e){if(!Zt(e))return{};let{results:t,binarys:r}=e;if(!Xt(t))return{};if(!_r(r))return{};let n={};try{n=JSON.parse(t,(function(e,t){if(Xt(t)){if(t.indexOf("[Uint8Array]::")>=0){let e=wr(t.replace("[Uint8Array]::",""));return r[e]}if(t.indexOf("[Uint16Array]::")>=0){let e=wr(t.replace("[Uint16Array]::",""));return r[e]}if(t.indexOf("[ArrayBuffer]::")>=0){let e=wr(t.replace("[ArrayBuffer]::",""));return r[e]}}return t}))}catch(e){}return n}({results:Pi(s.shift()),binarys:s})}catch(e){}return t}function Di(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={};e.port||(e.port=8080),e.apiName||(e.apiName="api");let a,u=new o.EventEmitter,c=oi();function s(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];setTimeout((()=>{u.emit(e,...r)}),1)}async function l(e){let r=Pr(),n=Pr(),o=ke(e,"_mode","");if(n.then((t=>{e.output=t,delete e.input,r.resolve(e)})).catch((e=>{r.reject(e)})),"execute"===o){s("execute",ke(e,"func",""),ke(e,"input",null),n)}else if("broadcast"===o){s("broadcast",ke(e,"input",null)),n.resolve("ok")}else if("deliver"===o){s("deliver",ke(e,"input",null)),n.resolve("ok")}else if("polling"===o){let r=ke(e,"clientId",""),o=ke(t,r,[]);o=ri(o),t[r]=[],n.resolve(o)}else{let t="can not find _mode in data";!function(e,t){s("error",{msg:e,err:t})}(t,e),r.reject(t),n.reject()}return r}setInterval((()=>{let e=Ln(c.get(),"key"),r={};ft(e,(e=>{r[e]=ke(t,e,[])})),t=r}),1e3),a=e.serverHapi?e.serverHapi:r.server({port:e.port,routes:{cors:{origin:["*"]}}}),s("open"),c.on("message",(function(e){let{eventName:t,key:r,data:n,now:o}=e;"enter"===t?s("clientEnter",r,n):"leave"===t&&s("clientLeave",r,n),s("clientChange",o)}));let f={path:"/"+e.apiName,method:"POST",options:{payload:{maxBytes:1073741824,timeout:18e4,multipart:!0},timeout:{socket:3e5}},handler:async function(e,t){let r=ke(e,"headers");r=Zt(r)?r:"";let n=ke(e,"query");n=Zt(n)?n:"",s("handler",{headers:r,query:n});let o=ke(e,"payload.bb",null);Kt(o)&&(o=Buffer.from(o,"utf8"));let a=Ei(new Uint8Array(o)),u=ke(a,"clientId"),f={headers:e.headers,info:e.info};c.trigger(u,f);let d={};await l(a).then((function(e){d.success=e})).catch((function(e){d.error=e}));let h=xi(d),p=new i.Readable;return p._read=()=>{},p.push(h),p.push(null),t.response(p).header("Cache-Control","no-cache, no-store, must-revalidate").header("Content-Type","application/octet-stream").header("Content-Length",p.readableLength)}};return u.broadcast=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(kr(t))return;let n={};ft(t,((t,r)=>{t.push({mode:"broadcast",data:e}),n[r]=t})),t=n,r(100)},u.deliver=function(e,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},o=ke(t,e,[]);o.push({mode:"deliver",data:r}),t[e]=o,n(100)},e.serverHapi?e.serverHapi.route(f):async function(){await a.register(n),a.route([{method:"GET",path:"/{file*}",handler:{directory:{path:"./"}}},f]),await a.start(),console.log(`Server running at: ${a.info.uri}`)}(),u}let Ui="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),Ni=Ui.length;function Bi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32,t=[];e=jr(e)?wr(e):32;for(let r=0;r<e;r++)t[r]=Ui[0|Math.random()*Ni];return t.join("")}var Ci=function(){return h.Date.now()},Ri="Expected a function",Fi=Math.max,Wi=Math.min;function Hi(e,t,r){var n,o,i,a,u,c,s=0,l=!1,f=!1,d=!0;if("function"!=typeof e)throw new TypeError(Ri);function h(t){var r=n,i=o;return n=o=void 0,s=t,a=e.apply(i,r)}function p(e){var r=e-c;return void 0===c||r>=t||r<0||f&&e-s>=i}function v(){var e=Ci();if(p(e))return y(e);u=setTimeout(v,function(e){var r=t-(e-c);return f?Wi(r,i-(e-s)):r}(e))}function y(e){return u=void 0,d&&n?h(e):(n=o=void 0,a)}function g(){var e=Ci(),r=p(e);if(n=arguments,o=this,c=e,r){if(void 0===u)return function(e){return s=e,u=setTimeout(v,t),l?h(e):a}(c);if(f)return clearTimeout(u),u=setTimeout(v,t),h(c)}return void 0===u&&(u=setTimeout(v,t)),a}return t=ur(t)||0,I(r)&&(l=!!r.leading,i=(f="maxWait"in r)?Fi(ur(r.maxWait)||0,t):i,d="trailing"in r?!!r.trailing:d),g.cancel=function(){void 0!==u&&clearTimeout(u),s=0,n=c=o=u=void 0},g.flush=function(){return void 0===u?a:y(Ci())},g}function Gi(e,t,r){(void 0!==r&&!Q(e[t],r)||void 0===r&&!(t in e))&&qn(e,t,r)}function Li(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}function zi(e,t,r,n,o,i,a){var u=Li(e,r),c=Li(t,r),s=a.get(c);if(s)Gi(e,r,s);else{var f,d=i?i(u,c,r+"",e,t,a):void 0,h=void 0===d;if(h){var p=l(c),v=!p&&Ce(c),y=!p&&!v&&Ke(c);d=c,p||v||y?l(u)?d=u:S(f=u)&&at(f)?d=io(u):v?(h=!1,d=oo(c,!0)):y?(h=!1,d=yo(c,!0)):d=[]:vi(c)||De(c)?(d=u,De(u)?d=function(e){return Zn(e,Qn(e))}(u):I(u)&&!U(u)||(d=Fo(c))):h=!1}h&&(a.set(c,d),o(d,c,n,i,a),a.delete(c)),Gi(e,r,d)}}function Yi(e,t,r,n,o){e!==t&&xe(t,(function(i,a){if(o||(o=new Gr),I(i))zi(e,t,a,r,Yi,n,o);else{var u=n?n(Li(e,a),i,a+"",e,t,o):void 0;void 0===u&&(u=i),Gi(e,a,u)}}),Qn)}var qi=Math.max;var Ji=Yn?function(e,t){return Yn(e,"toString",{configurable:!0,enumerable:!1,value:(r=t,function(){return r}),writable:!0});var r}:lt,Vi=Ji,Zi=Date.now;var Ki=function(e){var t=0,r=0;return function(){var n=Zi(),o=16-(n-r);if(r=n,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}(Vi),Xi=Ki;function Qi(e,t){return Xi(function(e,t,r){return t=qi(void 0===t?e.length-1:t,0),function(){for(var n=arguments,o=-1,i=qi(n.length-t,0),a=Array(i);++o<i;)a[o]=n[t+o];o=-1;for(var u=Array(t+1);++o<t;)u[o]=n[o];return u[t]=r(a),function(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}(e,this,u)}}(e,t,lt),e+"")}var ea,ta=(ea=function(e,t,r){Yi(e,t,r)},Qi((function(e,t){var r=-1,n=t.length,o=n>1?t[n-1]:void 0,i=n>2?t[2]:void 0;for(o=ea.length>3&&"function"==typeof o?(n--,o):void 0,i&&function(e,t,r){if(!I(r))return!1;var n=typeof t;return!!("number"==n?at(r)&&We(t,r.length):"string"==n&&t in r)&&Q(r[t],e)}(t[0],t[1],i)&&(o=n<3?void 0:o,n=1),e=Object(e);++r<n;){var a=t[r];a&&ea(e,a,r,o)}return e})));let ra=e.resolve();function na(){let e={},r=ke(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},"fnTableTags");Xt(r)||(r="tableTags.json"),r=`${ra}/${r}`;let n=Hr();function o(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];setTimeout((()=>{n.emit(e,...r)}),1)}function i(){let e={};try{if(t.existsSync(r)){let n=$r(t.readFileSync(r,"utf8"));Zt(n)&&(e=n)}}catch(e){o("error",{msg:"readTableTags catch",err:e})}return e}function a(){try{let n=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(Or(e))return"";let r="";try{r=t?JSON.stringify(e,null,2):JSON.stringify(e)}catch(e){r=""}return r}(e);t.writeFileSync(r,n,"utf8")}catch(e){o("error",{msg:"writeTableTags catch",err:e})}}let u=Hi((()=>{a(),o("changeTableTags",e)}),200);return n.readTableTags=i,n.writeTableTags=a,n.initTableTags=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"useInputFirst";e="useStorageFirst"===r?ta(t,i()):"useInputOnly"===r?t:"useStorageOnly"===r?i():ta(i(),t),a()},n.setTableTags=function(){e=ta(e,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),a()},n.getTableTags=function(){return e},n.updateTableTag=function(t){e[t]=function(){if(!Tr(s))throw new Error("invalid dayjs");return s().format("YYYY-MM-DDTHH:mm:ssZ")}()+"|"+Bi(6),u()},n}function oa(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Hr(),r=ke(e,"instWConverServer",null);if(null===r)return t.emit("error","invalid opt.instWConverServer"),t;let n=ke(e,"dbORMs",null);if(!Vt(n))return t.emit("error","invalid opt.dbORMs"),t;let o=ke(e,"tableNames",null);if(!_r(o))return t.emit("error","invalid opt.tableNames"),t;0===Jt(o)&&console.log("opt.tableNames.lenght = 0");let i=ke(e,"fnTableTags",null);Xt(i)||(i="tableTags.json");let a=new na({fnTableTags:i});o=ri(o);let u={};function c(e){let t={};return ft(o,(r=>{let n=r,o=e[r];t[n]=o})),t}return ft(o,(e=>{u[e]=Bi(6)})),a.initTableTags(u,"useInputOnly"),ft(o,(e=>{let t=n[e];if(!t)throw new Error(`invalid dbORMs.${e}`);t.on("change",(()=>{a.updateTableTag(e)}))})),r.on("clientEnter",(function(e,t){r.deliver(e,{mode:"syncTable",data:a.readTableTags()})})),a.on("changeTableTags",(e=>{r.broadcast({mode:"syncTable",data:c(e)})})),a}function ia(e){return ia="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ia(e)}function aa(e){var t=function(e,t){if("object"!=ia(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=ia(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ia(t)?t:t+""}function ua(e,t,r){return(t=aa(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ca(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function sa(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ca(Object(r),!0).forEach((function(t){ua(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ca(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}let la={},fa=null;async function da(e){let{func:t,input:r,pm:n}=e,o="";if(!ni(r,"__sysToken__"))return n.resolve({state:"error",msg:"invalid token"}),n;if(o=function(e){if(!Xt(e)&&!hr(e)&&!A(e))return"";let t="";try{t=String(e)}catch(e){}try{t=e.toString()}catch(e){}return t}(r.__sysToken__),!ni(r,"__sysInputArgs__"))return n.resolve({state:"error",msg:"invalid input"}),n;r=r.__sysInputArgs__;let i="",a=fa(o);if(i=xr(a)?await a:a,Xt(i)||(i=""),"getFuncList"===t){let e={state:"success",msg:ut(la)};return n.resolve(e),n}if(!ni(la,t))return n.resolve({state:"error",msg:`invalid func[${t}]`}),n;let u=la[t];try{let e=await Er(u)(i,...r);n.resolve(e)}catch(e){n.resolve({state:"error",msg:`無法識別func: ${t}`})}return n}function ha(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Hr(),r=ke(e,"instWConverServer",null);if(null===r)return t.emit("error","invalid opt.instWConverServer"),t;fa=ke(e,"cbGetUserIDFromToken",null),Tr(fa)||(fa=async()=>"");let n=ke(e,"useDbORM",null);Rr(n)||(n=!0);let o=null;if(n&&(o=ke(e,"operORM",null),!Tr(o)))return t.emit("error","invalid opt.operORM when useDbORM=true"),t;let i=[];if(n&&(i=ke(e,"tableNames",null),!_r(i)))return t.emit("error","invalid opt.tableNames when useDbORM=true"),t;let a=[];n&&(a=ke(e,"methods",null),_r(a)||(a=["select","insert","save","del"]));let u=ke(e,"extFuncs",null),c=ke(e,"hookBefores",null),s=ke(e,"hookAfters",null),l={};return n&&(i=ri(i),l=function(e,t,r){let n={};return ft(e,(e=>{ft(t,(t=>{n[`${e}.${t}`]=async function(n,o){return await r(n,e,t,o)}}))})),n}(i,a,o)),Vt(u)&&ft(u,((e,t)=>{l[t]=e})),la=l,r.on("execute",(async function(e,r,n){let o={func:e,input:r,pm:n};if(Tr(c))try{c(o)}catch(e){t.emit("error",e)}else Ar(c)&&ft(c,(e=>{if(Tr(e))try{e(o)}catch(e){t.emit("error",e)}}));let i=await da(o).catch((e=>{t.emit("error",e)})),a=sa(sa({},o),{},{output:i});if(Tr(s))try{s(a)}catch(e){t.emit("error",e)}else Ar(s)&&ft(s,(e=>{if(Tr(e))try{e(a)}catch(e){t.emit("error",e)}}))})),t}function pa(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=null,r=null,n=Hr(),o=ke(e,"instWConverServer",null);if(null===o)return n.emit("error","invalid opt.instWConverServer"),n;let i=ke(e,"useDbORM",null);Rr(i)||(i=!0);let a=ke(e,"dbORMs",null),u=ke(e,"operORM",null),c=ke(e,"tableNamesExec",null),s=ke(e,"methodsExec",null),l=ke(e,"tableNamesSync",null),f=ke(e,"cbGetUserIDFromToken",null),d=ke(e,"extFuncs",null),h=ke(e,"hookBefores",null),p=ke(e,"hookAfters",null),v=ke(e,"fnTableTags",null);if(t=new ha({instWConverServer:o,cbGetUserIDFromToken:f,useDbORM:i,operORM:u,tableNames:c,methods:s,extFuncs:d,hookBefores:h,hookAfters:p}),t.on("error",(e=>{n.emit("error",e)})),i){if(!Vt(a))return n.emit("error","invalid opt.dbORMs when useDbORM=true"),n;r=new oa({instWConverServer:o,dbORMs:a,tableNames:l,fnTableTags:v}),r.on("error",(e=>{n.emit("error",e)}))}return n.getInstWServWebdataServerExec=()=>t,n.getInstWServWebdataServerSync=()=>r,n}function va(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=null,o=null,i=null,a=Hr(),u=ke(e,"port");vr(u)||(u=8080);let c=ke(e,"useCors");Rr(c)||(c=!0);let s=ke(e,"useInert");Rr(s)||(s=!0);let l=ke(e,"pathStaticFiles");Xt(l)||(l="dist");let f=ke(e,"apis");Ar(f)||(f=[]);let d=ke(e,"getUserIDFromToken",null),h=ke(e,"useDbORM",null);Rr(h)||(h=!0);let p=ke(e,"dbORMs",null),v=ke(e,"operORM",null),y=ke(e,"tableNamesExec",null),g=ke(e,"methodsExec",null),b=ke(e,"tableNamesSync",null),m=ke(e,"extFuncs",null),w=ke(e,"hookBefores",null),j=ke(e,"hookAfters",null),_=ke(e,"fnTableTags",null),O=ke(e,"showLog");Rr(O)||(O=!0);return(async()=>{await(async()=>{t=new r.Server({port:u,routes:{cors:c}}),s&&await t.register(n);let e=[];s&&(e=[{method:"GET",path:"/{file*}",handler:{directory:{path:`${l}/`}}}]),e=[...e,...f],t.route(e)})(),await(async()=>{o=new Di({serverHapi:t}),o.on("open",(function(){O&&console.log(`Server[port:${u}]: open`)})),o.on("error",(function(e){O&&console.log(`Server[port:${u}]: error`,e),a.emit("error",{mode:"instWConverhpServer error",err:e})})),o.on("clientChange",(function(e){O&&console.log(`Server[port:${u}]: now clients: ${e}`)}))})(),await(async()=>{i=new pa({instWConverServer:o,cbGetUserIDFromToken:d,useDbORM:h,dbORMs:p,operORM:v,tableNamesExec:y,tableNamesSync:b,methodsExec:g,extFuncs:m,hookBefores:w,hookAfters:j,fnTableTags:_}),i.on("error",(e=>{O&&console.log("error",e),a.emit("error",{mode:"instWServWebdataServer error",err:e})}))})(),await t.start(),O&&console.log(`Server running at: ${t.info.uri}`)})(),process.on("unhandledRejection",(e=>{console.log("unhandledRejection",e),a.emit("error",{mode:"unhandledRejection",err:e})})),process.on("uncaughtException",(e=>{console.log("uncaughtException",e),a.emit("error",{mode:"uncaughtException",err:e})})),a.getServer=()=>t,a.getInstWConverhpServer=()=>o,a.getInstWServWebdataServer=()=>i,a}function ya(e){return e!=e}function ga(e,t,r){return t==t?function(e,t,r){for(var n=r-1,o=e.length;++n<o;)if(e[n]===t)return n;return-1}(e,t,r):function(e,t,r,n){for(var o=e.length,i=r+(n?1:-1);n?i--:++i<o;)if(t(e[i],i,e))return i;return-1}(e,ya,r)}var ba="\\ud800-\\udfff",ma="["+ba+"]",wa="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",ja="\\ud83c[\\udffb-\\udfff]",_a="[^"+ba+"]",Oa="(?:\\ud83c[\\udde6-\\uddff]){2}",Sa="[\\ud800-\\udbff][\\udc00-\\udfff]",ka="(?:"+wa+"|"+ja+")"+"?",Aa="[\\ufe0e\\ufe0f]?",Ta=Aa+ka+("(?:\\u200d(?:"+[_a,Oa,Sa].join("|")+")"+Aa+ka+")*"),xa="(?:"+[_a+wa+"?",wa,Oa,Sa,ma].join("|")+")",$a=RegExp(ja+"(?="+ja+")|"+xa+Ta,"g");function Ia(e){return Pt(e)?function(e){return e.match($a)||[]}(e):function(e){return e.split("")}(e)}function Ma(e,t,r){if((e=we(e))&&(r||void 0===t))return tr(e);if(!e||!(t=me(t)))return e;var n=Ia(e),o=Ia(t),i=function(e,t){for(var r=-1,n=e.length;++r<n&&ga(t,e[r],0)>-1;);return r}(n,o),a=function(e,t){for(var r=e.length;r--&&ga(t,e[r],0)>-1;);return r}(n,o)+1;return function(e,t,r){var n=e.length;return r=void 0===r?n:r,!t&&r>=n?e:Dr(e,t,r)}(n,i,a).join("")}let Pa={backup:async function(e){return await Ur(e,(async(e,t)=>(console.log("backup...",t),{name:t,data:await e.select()})))},recover:async function(e,r,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!Nr(e))throw console.log("fp",e),new Error("fp is not exist");if(!Zt(r))throw console.log("woItems",r),new Error("invalid woItems");Tr(n)||(n=null),Rr(o)||(o=!1);let i=t.readFileSync(e,"utf8");i=Ma(i);let a=$r(i);Tr(n)&&n(),await Ur(a,(async e=>{console.log("recover...",e.name),o&&(console.log("needCreateStorage"),await r[e.name].createStorage());let t=null;return Jt(e.data)>0&&(t=await r[e.name].insert(e.data)),t}))}};function Ea(){if(!Tr(s))throw new Error("invalid dayjs");return s().format("YYYY-MM-DDTHH:mm:ss.SSSZ")}let Da=null,Ua=null;function Na(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"save";if(!Zt(Da))throw console.log("ds",Da),new Error("invalid ds");let o=Da[e].keys,i=!1;_r(r)||(i=!0,r=[r]);let a=Ea();return n.indexOf("insert")>=0&&(o.indexOf("userId")>=0&&ft(r,((e,n)=>{r[n].userId=t})),o.indexOf("timeCreate")>=0&&ft(r,((e,t)=>{r[t].timeCreate=a}))),(n.indexOf("insert")>=0||n.indexOf("save")>=0)&&(o.indexOf("userIdUpdate")>=0&&ft(r,((e,n)=>{r[n].userIdUpdate=t})),o.indexOf("timeUpdate")>=0&&ft(r,((e,t)=>{r[t].timeUpdate=a}))),r=i?r[0]:r}async function Ba(e,t,r,n){let o,i=null;if(!Zt(Ua))return Promise.reject("無有效woItems");let a=ke(Ua,t,null);if(null===a)return Promise.reject(`ORM找不到表名稱: ${t}`);if("select"===r){if(o=await a.select(n).catch((e=>{console.log(`${t}.select catch`,e),i="取得資料失敗"})),Xt(i))return Promise.reject(i)}else if("insert"===r||"save"===r){try{n=Na(t,e,n,r)}catch(e){return console.log("adjustData catch",e.toString()),i="調整資料失敗",Promise.reject(i)}if("insert"===r?o=await a.insert(n).catch((e=>{console.log(`${t}.save catch`,e),i="新增資料失敗"})):"save"===r&&(o=await a.save(n,{atomic:!0}).catch((e=>{console.log(`${t}.save catch`,e),i="儲存資料失敗"}))),Xt(i))return Promise.reject(i);o=_r(n)?Ln(n,(e=>({id:e.id}))):{id:n.id}}else if("del"===r)o=await a.del(n).catch((e=>{console.log(`${t}.del catch`,e),i="刪除資料失敗"}));else if("delAll"===r)o=await a.delAll(n).catch((e=>{console.log(`${t}.delAll catch`,e),i="刪除資料失敗"}));else if("mix"===r){if(!Zt(n))return Promise.reject("mix僅支援輸入ltdtDiffByKey結果物件");let r;o=[];let u=ke(n,"add",[]);if(Jt(u)>0){try{u=Na(t,e,u,"insert+save")}catch(e){return console.log("adjustData catch",e.toString()),i="調整資料失敗",Promise.reject(i)}if(await a.insert(u).catch((e=>{console.log(`${t}.save catch`,e),i="新增資料失敗"})),Xt(i))return Promise.reject(i);r=Ln(u,(e=>({id:e.id}))),o=[...o,...r]}let c=ke(n,"del",[]);if(Jt(c)>0){if(await a.del(c).catch((e=>{console.log(`${t}.save catch`,e),i="刪除資料失敗"})),Xt(i))return Promise.reject(i);r=Ln(c,(e=>({id:e.id}))),o=[...o,...r]}let s=ke(n,"diff",[]);if(Jt(s)>0){try{s=Na(t,e,s)}catch(e){return console.log("adjustData catch",e.toString()),i="調整資料失敗",Promise.reject(i)}if(await a.save(s).catch((e=>{console.log(`${t}.save catch`,e),i="變更資料失敗"})),Xt(i))return Promise.reject(i);r=Ln(s,(e=>({id:e.id}))),o=[...o,...r]}}else i=`invalid mode: ${r}`;return Xt(i)?Promise.reject(i):o}function Ca(e,t){return Da=e,Ua=t,Ba}function Ra(e,t){var r=[];return st(e,(function(e,n,o){t(e,n,o)&&r.push(e)})),r}function Fa(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!_r(e)){let e=Pr();return e.reject("pms is not an array"),e}return e.reduce(((e,t)=>e.then(t)),Promise.resolve(t))}let Wa=[],Ha=[],Ga=[],La=null,za=null,Ya=!0,qa=!0;function Ja(e){setTimeout((()=>{Wa.push(e)}),1)}function Va(e){setTimeout((()=>{Ha.push(e)}),1)}function Za(e){setTimeout((()=>{Ga.push(e)}),1)}async function Ka(e,t,r,n){if(!Tr(La))return Promise.reject("invalid mapOrm");if(Ya&&!Xt(e))return console.log("userId",e),console.log("找不到使用者主鍵"),Promise.reject("找不到使用者主鍵");let o="n";if(Ya){if(!Tr(za))return Promise.reject("invalid getUserById");let t=await za(e);if(!t)return console.log("userId",e),console.log("找不到使用者資訊"),Promise.reject("找不到使用者資訊");o=ke(t,"isAdmin"),"y"!==o&&"n"!==o&&(o="n");let r=ke(t,"isActive");if("y"!==r&&"n"!==r&&(r="n"),"y"!==r)return console.log("userId",e),console.log("oSelf",t),console.log("使用者被停權或無有效使用者資訊"),Promise.reject("使用者被停權或無有效使用者資訊")}if(await Ur(Wa,(i=>i({woName:t,userId:e,isAdmin:o,mode:r,input:n}))),Jt(Ha)>0){let i={woName:t,userId:e,isAdmin:o,mode:r,input:n},a=await Fa(Ha,i);n=a.input}let i=await La(e,t,r,n);var a,u;return qa&&"n"===o&&"select"===r&&_r(i)&&(u=e=>!(ni(e,"isActive")&&"n"===e.isActive),i=(l(a=i)?gn:Ra)(a,Hn(u))),Jt(Ga)>0&&(i=await Fa(Ga,{woName:t,userId:e,isAdmin:o,mode:r,input:n,output:i})),i}function Xa(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Qa(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Xa(Object(r),!0).forEach((function(t){ua(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Xa(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function eu(e,t,r,n){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=function(e,t,r,n){if(!Zt(e))throw console.log("ds",e),new Error("invalid ds");if(!Tr(t))throw console.log("WOrm",t),new Error("invalid WOrm");if(!Xt(r))throw console.log("url",r),new Error("invalid url");if(!Xt(n))throw console.log("db",n),new Error("invalid db");let o={};return ft(ut(e),(e=>{let i=new t({url:r,db:n,cl:e});o[e]=i})),o}(e,t,r,n),a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Tr(e)?(La=e,Ya=ke(t,"bCheckUser"),Rr(Ya)||(Ya=!0),za=ke(t,"getUserById"),qa=ke(t,"bExcludeWhenNotAdmin"),Rr(qa)||(qa=!0),{addFunCheck:Ja,addFunPreProcessing:Va,addFunPostProcessing:Za,procOrm:Ka}):Promise.reject("invalid mapOrm")}(Ca(e,i),o);return Qa(Qa({},Pa),{},{woItems:i},a)}function tu(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(!Ar(t))return{};let n={};return ft(t,(function(t){n[t]=ke(e,t,r)})),n}function ru(){if(!Tr(s))throw new Error("invalid dayjs");return s().format("YYYYMMDDHHmmss")}let nu={id:{pk:!0,name:"主鍵",type:"STRING"},token:{name:"金鑰",type:"STRING"},userId:{name:"使用者主鍵",type:"STRING"},timeCreate:{name:"創建時間",type:"STRING"},timeEnd:{name:"到期時間",type:"STRING"},timeUpdate:{name:"更新時間",type:"STRING"}},ou={keyTable:"tokens",tableNameCht:"金鑰",tableNameEng:"Tokens",settings:nu,funNew:function(){let e=tu(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},ut(nu));return e.id=`${ru()}-${Bi()}`,e.token=`${ru()}-${Bi()}`,e.timeCreate=Ea(),e.timeEnd=s().add(30,"minute").format(),e.timeUpdate=e.timeCreate,e},funTest:()=>[]},iu={id:{pk:!0,name:"主鍵",type:"STRING"},order:{name:"順序",type:"INTEGER"},account:{name:"帳號",type:"STRING"},password:{name:"密碼",type:"STRING"},name:{name:"姓名",type:"STRING"},email:{name:"電子郵件",type:"STRING"},description:{name:"描述",type:"TEXT"},from:{name:"來源",type:"STRING"},ruleGroupsIds:{name:"所屬權限群組主鍵",type:"STRING"},redir:{name:"登入後轉址",type:"STRING"},isAdmin:{name:"是否為系統管理員",type:"STRING"},userId:{name:"創建使用者主鍵",type:"STRING"},timeCreate:{name:"創建時間",type:"STRING"},userIdUpdate:{name:"最新變更使用者主鍵",type:"STRING"},timeUpdate:{name:"更新時間",type:"STRING"},isActive:{name:"是否有效",type:"STRING"}},au={keyTable:"users",tableNameCht:"使用者",tableNameEng:"Users",settings:iu,funNew:function(){let e=tu(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},ut(iu));return e.id=`${ru()}-${Bi()}`,e.isAdmin="n",e.userIdUpdate=e.userId,e.timeCreate=Ea(),e.timeUpdate=e.timeCreate,e.isActive="y",e},funTest:()=>[]};function uu(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function cu(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?uu(Object(r),!0).forEach((function(t){ua(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):uu(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function su(e){let t=ke(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"useCreateStorage");Rr(t)||(t=!1);let{keyTable:r,tableNameCht:n,tableNameEng:o,settings:i,parser:a,funNew:u,funTest:c,ext:s}=e;if(!Xt(r))throw new Error(`invalid keyTable[${r}]`);if(Xt(n)||(n=r),Xt(o)||(o=r),!Zt(i))throw new Error("invalid settings");Zt(s)||(s=null),Zt(a)||(a=null),Tr(u)||(u=null);let l=null;Tr(c)&&(l=async e=>{if(!Zt(e))throw new Error("invalid wo");if(!ni(e,r))throw console.log(e),new Error(`keyTable[${r}] is not in wo`);let n=[];try{n=c(),xr(n)&&(n=await n)}catch(e){throw console.log(`keyTable[${r}] funTest catch`,e),new Error(e)}if(0!==Jt(n))return t&&await e[r].createStorage(),await e[r].save(n),n});let f={},d={};return ft(ut(i),(e=>{let t=ke(i,`${e}.name`,"");Xt(t)&&(f[e]=t);let r=ke(i,`${e}.type`,"");Xt(r)&&(d[e]=r)})),cu(cu({},e),{},{keyTable:r,tableNameCht:n,tableNameEng:o,settings:i,keys:ut(i),kpType:d,kpHead:f,parser:a,funNew:u,funTest:c,funTestAndSave:l,ext:s})}let lu={tokens:ou,users:au},fu={};for(let e in lu)fu[e]=su(lu[e],{useCreateStorage:!1});var du,hu={exports:{}},pu={exports:{}};!function(e,t){var r;e.exports=(r=_i(),du||(du=1,function(e,t){var r,n,o,i,a,u,c;e.exports=(o=(n=c=_i()).lib,i=o.Base,a=o.WordArray,(u=n.x64={}).Word=i.extend({init:function(e,t){this.high=e,this.low=t}}),u.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=t!=r?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var o=e[n];r.push(o.high),r.push(o.low)}return a.create(r,this.sigBytes)},clone:function(){for(var e=i.clone.call(this),t=e.words=this.words.slice(0),r=t.length,n=0;n<r;n++)t[n]=t[n].clone();return e}}),c)}(pu)),function(){var e=r,t=e.lib.Hasher,n=e.x64,o=n.Word,i=n.WordArray,a=e.algo;function u(){return o.create.apply(o,arguments)}var c=[u(1116352408,3609767458),u(1899447441,602891725),u(3049323471,3964484399),u(3921009573,2173295548),u(961987163,4081628472),u(1508970993,3053834265),u(2453635748,2937671579),u(2870763221,3664609560),u(3624381080,2734883394),u(310598401,1164996542),u(607225278,1323610764),u(1426881987,3590304994),u(1925078388,4068182383),u(2162078206,991336113),u(2614888103,633803317),u(3248222580,3479774868),u(3835390401,2666613458),u(4022224774,944711139),u(264347078,2341262773),u(604807628,2007800933),u(770255983,1495990901),u(1249150122,1856431235),u(1555081692,3175218132),u(1996064986,2198950837),u(2554220882,3999719339),u(2821834349,766784016),u(2952996808,2566594879),u(3210313671,3203337956),u(3336571891,1034457026),u(3584528711,2466948901),u(113926993,3758326383),u(338241895,168717936),u(666307205,1188179964),u(773529912,1546045734),u(1294757372,1522805485),u(1396182291,2643833823),u(1695183700,2343527390),u(1986661051,1014477480),u(2177026350,1206759142),u(2456956037,344077627),u(2730485921,1290863460),u(2820302411,3158454273),u(3259730800,3505952657),u(3345764771,106217008),u(3516065817,3606008344),u(3600352804,1432725776),u(4094571909,1467031594),u(275423344,851169720),u(430227734,3100823752),u(506948616,1363258195),u(659060556,3750685593),u(883997877,3785050280),u(958139571,3318307427),u(1322822218,3812723403),u(1537002063,2003034995),u(1747873779,3602036899),u(1955562222,1575990012),u(2024104815,1125592928),u(2227730452,2716904306),u(2361852424,442776044),u(2428436474,593698344),u(2756734187,3733110249),u(3204031479,2999351573),u(3329325298,3815920427),u(3391569614,3928383900),u(3515267271,566280711),u(3940187606,3454069534),u(4118630271,4000239992),u(116418474,1914138554),u(174292421,2731055270),u(289380356,3203993006),u(460393269,320620315),u(685471733,587496836),u(852142971,1086792851),u(1017036298,365543100),u(1126000580,2618297676),u(1288033470,3409855158),u(1501505948,4234509866),u(1607167915,987167468),u(1816402316,1246189591)],s=[];!function(){for(var e=0;e<80;e++)s[e]=u()}();var l=a.SHA512=t.extend({_doReset:function(){this._hash=new i.init([new o.init(1779033703,4089235720),new o.init(3144134277,2227873595),new o.init(1013904242,4271175723),new o.init(2773480762,1595750129),new o.init(1359893119,2917565137),new o.init(2600822924,725511199),new o.init(528734635,4215389547),new o.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],o=r[1],i=r[2],a=r[3],u=r[4],l=r[5],f=r[6],d=r[7],h=n.high,p=n.low,v=o.high,y=o.low,g=i.high,b=i.low,m=a.high,w=a.low,j=u.high,_=u.low,O=l.high,S=l.low,k=f.high,A=f.low,T=d.high,x=d.low,$=h,I=p,M=v,P=y,E=g,D=b,U=m,N=w,B=j,C=_,R=O,F=S,W=k,H=A,G=T,L=x,z=0;z<80;z++){var Y,q,J=s[z];if(z<16)q=J.high=0|e[t+2*z],Y=J.low=0|e[t+2*z+1];else{var V=s[z-15],Z=V.high,K=V.low,X=(Z>>>1|K<<31)^(Z>>>8|K<<24)^Z>>>7,Q=(K>>>1|Z<<31)^(K>>>8|Z<<24)^(K>>>7|Z<<25),ee=s[z-2],te=ee.high,re=ee.low,ne=(te>>>19|re<<13)^(te<<3|re>>>29)^te>>>6,oe=(re>>>19|te<<13)^(re<<3|te>>>29)^(re>>>6|te<<26),ie=s[z-7],ae=ie.high,ue=ie.low,ce=s[z-16],se=ce.high,le=ce.low;q=(q=(q=X+ae+((Y=Q+ue)>>>0<Q>>>0?1:0))+ne+((Y+=oe)>>>0<oe>>>0?1:0))+se+((Y+=le)>>>0<le>>>0?1:0),J.high=q,J.low=Y}var fe,de=B&R^~B&W,he=C&F^~C&H,pe=$&M^$&E^M&E,ve=I&P^I&D^P&D,ye=($>>>28|I<<4)^($<<30|I>>>2)^($<<25|I>>>7),ge=(I>>>28|$<<4)^(I<<30|$>>>2)^(I<<25|$>>>7),be=(B>>>14|C<<18)^(B>>>18|C<<14)^(B<<23|C>>>9),me=(C>>>14|B<<18)^(C>>>18|B<<14)^(C<<23|B>>>9),we=c[z],je=we.high,_e=we.low,Oe=G+be+((fe=L+me)>>>0<L>>>0?1:0),Se=ge+ve;G=W,L=H,W=R,H=F,R=B,F=C,B=U+(Oe=(Oe=(Oe=Oe+de+((fe+=he)>>>0<he>>>0?1:0))+je+((fe+=_e)>>>0<_e>>>0?1:0))+q+((fe+=Y)>>>0<Y>>>0?1:0))+((C=N+fe|0)>>>0<N>>>0?1:0)|0,U=E,N=D,E=M,D=P,M=$,P=I,$=Oe+(ye+pe+(Se>>>0<ge>>>0?1:0))+((I=fe+Se|0)>>>0<fe>>>0?1:0)|0}p=n.low=p+I,n.high=h+$+(p>>>0<I>>>0?1:0),y=o.low=y+P,o.high=v+M+(y>>>0<P>>>0?1:0),b=i.low=b+D,i.high=g+E+(b>>>0<D>>>0?1:0),w=a.low=w+N,a.high=m+U+(w>>>0<N>>>0?1:0),_=u.low=_+C,u.high=j+B+(_>>>0<C>>>0?1:0),S=l.low=S+F,l.high=O+R+(S>>>0<F>>>0?1:0),A=f.low=A+H,f.high=k+W+(A>>>0<H>>>0?1:0),x=d.low=x+L,d.high=T+G+(x>>>0<L>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=t.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});e.SHA512=t._createHelper(l),e.HmacSHA512=t._createHmacHelper(l)}(),r.SHA512)}(hu);var vu=u(hu.exports),yu={exports:{}};!function(e,t){e.exports=_i().enc.Hex}(yu);var gu=u(yu.exports);function bu(e,t){let r=ke(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},"mode","");if(Xt(r)||(r="sha512"),"sha512"!==r)throw new Error("暫時不支援sha512以外方法");let n=`${e}:${t}`;return n=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Xt(e))return"";if(!Rr(t))return"";let r=vu(e),n="";return n=t?r.toString(ki):r.toString(gu),n}(n),n}function mu(e,t){let{salt:r,timeExpired:n}=t,o=async t=>{let r=await(async(t,r)=>{let n=ke(await e.users.select({[t]:r,isActive:"y"}),0,null);return Zt(n)?n:null})("account",t);return Zt(r)?r:null},i=async t=>{let r=null,o=fu.tokens.funNew({userId:t});o.timeEnd=s().add(n,"minute").format("YYYY-MM-DDTHH:mm:ss.SSSZ");let i=ke(o,"token","");return await e.tokens.insert(o).catch((e=>{r=e})),r?(console.log(r),console.log("token",i),console.log("Can not create a token from userId"),Promise.reject("Can not create a token from userId")):i},a=async e=>{let t=ke(e,"timeEnd",""),r=s(t,"YYYY-MM-DDTHH:mm:ss.SSSZ"),o=s(),i=r.diff(o,"minutes");return!(i>n)||(console.log("tk",e),console.log("dmin",i,"timeExpired",n),console.log("token expired"),Promise.reject("token expired"))},u=async t=>{let r=await e.tokens.select({token:t}),n=Jt(r);if(0===n)return console.log("token",t),console.log("invalid token"),Promise.reject("invalid token");if(n>=2)return console.log("token",t),console.log("duplicate tokens"),Promise.reject("duplicate tokens");let o=ke(r,0,"");return await a(o),!0};return{loginByAccountAndPassword:async(e,t)=>{let n=bu(t,r),a=await o(e);if(!Zt(a))return console.log("account",e),console.log("can not find the user from account"),Promise.reject("can not find the user from account");if(n!==ke(a,"password",""))return Promise.reject("incorrect user account or password");let u=ke(a,"id",""),c=await i(u);return{id:a.id,account:a.account,name:a.name,email:a.email,description:a.description,from:a.from,ruleGroupsIds:a.ruleGroupsIds,redir:a.redir,isAdmin:a.isAdmin,isActive:a.isActive,token:c}},checkToken:u,refreshToken:async t=>{let r=null,o=await e.tokens.select({token:t}),i=Jt(o);if(0===i)return console.log("token",t),console.log("invalid token"),Promise.reject("invalid token");if(i>=2)return console.log("token",t),console.log("duplicate tokens"),Promise.reject("duplicate tokens");let a=ke(o,0,""),u=ke(a,"timeEnd",""),c=s(u,"YYYY-MM-DDTHH:mm:ss.SSSZ"),l=s(),f=c.diff(l,"minutes");if(f>n)return console.log("token",t),console.log("dmin",f,"timeExpired",n),console.log("token expired"),Promise.reject("token expired");let d=l.format("YYYY-MM-DDTHH:mm:ss.SSSZ");return await e.tokens.save({id:a.id,timeEnd:d}).catch((e=>{r=e})),!r||(console.log(r),console.log("token",t),console.log("Can not update time for token"),Promise.reject("Can not update time for token"))},getUserByToken:async t=>{let r=null,n=await e.tokens.select({token:t}),o=Jt(n);if(0===o)return console.log("token",t),console.log("invalid token"),Promise.reject("invalid token");if(o>=2)return console.log("token",t),console.log("duplicate tokens"),Promise.reject("duplicate tokens");let i=ke(n,0,""),a=ke(i,"userId",""),u=await e.users.select({id:a}).catch((e=>{r=e}));if(r)return console.log(r),console.log("userId",a),console.log("Failed to find user"),Promise.reject("Failed to find user");let c=Jt(u);if(0===c)return console.log("userId",a),console.log("can not find the user by userId"),Promise.reject("can not find the user by userId");if(c>=2)return console.log("userId",a),console.log("duplicate userId"),Promise.reject("duplicate userId");let s=ke(u,0,"");return{id:s.id,account:s.account,name:s.name,email:s.email,description:s.description,from:s.from,ruleGroupsIds:s.ruleGroupsIds,redir:s.redir,isAdmin:s.isAdmin,isActive:s.isActive,token:t}},logOutByToken:async t=>{let r=null,n=await e.tokens.select({token:t}),o=Jt(n);if(0===o)return console.log("token",t),console.log("invalid token"),Promise.reject("invalid token");if(o>=2)return console.log("token",t),console.log("duplicate tokens"),Promise.reject("duplicate tokens");let i=ke(n,0,"");ke(i,"userId","");let a=await e.tokens.del({id:i.id}).catch((e=>{r=e}));return r?(console.log(r),console.log("token",t),console.log("Failed to delete token"),Promise.reject("Failed to delete token")):(a=ke(a,"0.nDeleted",0),1===a||(console.log("token",t),console.log("Can not delete the token"),Promise.reject("Can not delete the token")))},cleanTokens:async()=>{let t=await e.tokens.select(),r=[];await Ur(t,(async e=>{let t=null;await a(e).catch((e=>{t=e})),t&&r.push(e)})),Jt(r)>0&&await Ur(t,(async t=>{await e.tokens.del({id:t.id}).catch((()=>{}))}))},createUser:async()=>{},ModifyUser:async()=>{},DeleteUser:async()=>{},AuthUser:async()=>{},EmailUser:async()=>{},getUsersList:async t=>(await u(t),await e.users.select()),getUserInfor:async(t,r,n)=>{await u(t);let o=ke(await e.users.select({[r]:n,isActive:"y"}),0,{});return Zt(o)?{id:o.id,account:o.account,name:o.name,email:o.email,description:o.description,from:o.from,ruleGroupsIds:o.ruleGroupsIds,redir:o.redir,isAdmin:o.isAdmin,isActive:o.isActive,token:t}:(console.log("token",t),console.log("key",r,"value",n),console.log("Can not find user"),Promise.reject("Can not find user"))}}}return function(r,n,o,i,a,u){let c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},s=null;if(!Tr(r))throw console.log("invalid WOrm",r),new Error("invalid WOrm");if(!Xt(n))throw console.log("invalid url",n),new Error("invalid url");if(!Xt(o))throw console.log("invalid db",o),new Error("invalid db");if(!Tr(i))throw console.log("invalid getUserByToken",i),new Error("invalid getUserByToken");if(!Tr(a))throw console.log("invalid verifyBrowserUser",a),new Error("invalid verifyBrowserUser");if(!Tr(u))throw console.log("invalid verifyAppUser",u),new Error("invalid verifyAppUser");let l=ke(c,"serverPort");jr(l)||(l=11007),l=wr(l);let f=ke(c,"bCheckUser",!1),d=ke(c,"getUserById",null),h=ke(c,"bExcludeWhenNotAdmin",!1),p=ke(c,"webName",{}),v=ke(c,"webDescription",{}),y=ke(c,"webLogo",""),g=ke(c,"webBackgoundGradientColors",[]);Ar(g)||(g=["#FFE0B2","#FFCC80","#FFF59D"]);let b=ke(c,"webKey",""),m=ke(c,"salt",""),w=ke(c,"timeExpired","");var j;hr(j=w)&&pr(j)>0&&(w=30);let _=ke(c,"subfolder","");var O,S;Xt(_)&&("/"===function(e,t){if(!Xt(e))return"";if(!Ir(t))return"";if(0===(t=wr(t)))return"";let r=e.length-t;return r<0&&(r=0),e.substr(r,t)}(_,1)&&(S=1,_=Xt(O=_)&&Ir(S)?0===(S=wr(S))?O:Mr(O,O.length-S):""),"/"!==Mr(_,1)&&(_=`/${_}`));let k=ke(c,"urlRedirect","");ke(c,"mappingBy","");let A={bCheckUser:f,getUserById:d,bExcludeWhenNotAdmin:h},T={};try{T=eu(fu,r,n,o,A)}catch(e){console.log(e)}let{woItems:x,procOrm:$}=T,I=e=>({webName:p,webDescription:v,webLogo:y,webBackgoundGradientColors:g,webKey:b}),M=mu(x,{salt:m,timeExpired:w}),P="none";setInterval((()=>{"doing"!==P&&(P="doing",M.cleanTokens().finally((()=>{P="none"})))}),1e3);let E="dist",D="./node_modules/w-web-sso/dist";var U;U=D,!t.existsSync(U)||t.lstatSync(U).isFile()||t.lstatSync(U).isSymbolicLink()||(E=D);let N="index.html";try{let r=e.resolve(E,"index.tmp");if(Nr(r)||(r=e.resolve(E,N)),!Nr(r))throw console.log("fpEntryIn",r),new Error("invalid fpEntryIn");let n=e.resolve(E,N),o=t.readFileSync(r,"utf8");o=Br(o,"/msso/","{sfd}/"),o=Br(o,"{sfd}",_),o=Br(o,"{urlRedirect}",k),t.writeFileSync(n,o,"utf8")}catch(e){console.log(e),console.log(`can not generate ${N}`)}let B=[{method:"GET",path:"/getWebInfor",handler:async function(e,t){return I()}},{method:"GET",path:"/api/logoutSsoUser",handler:async function(e,t){return await Er((async function(){let t=ke(e,"query.token","");return await M.logOutByToken(t)}))()}},{method:"GET",path:"/api/checkToken",handler:async function(e,t){return await Er((async function(){let t=ke(e,"query.token","");return await M.checkToken(t)}))()}},{method:"GET",path:"/api/getSsoUsersList",handler:async function(e,t){return await Er((async function(){let t=ke(e,"query.token","");return await M.getUsersList(t)}))()}},{method:"GET",path:"/api/getSsoUserInfor",handler:async function(e,t){return await Er((async function(){let t=ke(e,"query.token",""),r=ke(e,"query.key",""),n=ke(e,"query.value",""),o=null;return o="token"===r?await M.getUserByToken(n):await M.getUserInfor(t,r,n),Zt(o)?o:(console.log("token",t),console.log("key",r,"value",n),console.log("token does not have permission"),Promise.reject("token does not have permission"))}))()}}],C=ut(fu);return s=new va({port:c.serverPort,pathStaticFiles:E,apis:B,getUserIDFromToken:async e=>"",useDbORM:!0,dbORMs:x,operORM:$,tableNamesExec:C,methodsExec:["select","insert","save","del","delAll"],tableNamesSync:[],extFuncs:{getWebInfor:I,getUserByToken:(e,t)=>M.getUserByToken(t),loginByAccountAndPassword:(e,t,r)=>M.loginByAccountAndPassword(t,r),checkToken:(e,t)=>M.checkToken(t),refreshToken:(e,t)=>M.refreshToken(t),logOutByToken:(e,t)=>M.logOutByToken(t),getUsersList:(e,t)=>M.getUsersList(t)},hookBefores:null,hookAfters:null,fnTableTags:"tableTags-web-sso.json"}),s}}));
//# sourceMappingURL=w-web-sso.umd.js.map
